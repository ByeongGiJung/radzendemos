@page "/createmessage"

@using TempTitle.Data.ViewModel.CreateMessageModel
@using System.Text.Json;

<PageTitle>메시지 작성</PageTitle>

<RadzenContentContainer>
    <RadzenRow>
        <RadzenColumn>
            <RadzenCard class="mb-2">
                <RadzenRow class="mb-2">
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="거래소" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-5 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Exchanges" Class="w-auto" Placeholder="거래소를 선택하세요."
                            @bind-Value="createMessageModel.exchange" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="계정" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-5 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Accounts" Class="w-auto"
                            @bind-Value="createMessageModel.account" />
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow class="mb-2">
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="거래종목" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-5 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Symbols" Class="w-auto" Placeholder="거래할 종목을 선택하세요"
                            @bind-Value="createMessageModel.symbol" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="거래마켓" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-5 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Markets" Class="w-auto" Placeholder="거래할 마켓을 선택하세요."
                            @bind-Value="createMessageModel.market" />
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow class="mb-2">
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="주문유형" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-5 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Types" Class="w-auto"
                            @bind-Value="createMessageModel.type" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="주문방법" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-5 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Sides" Class="w-auto"
                            @bind-Value="createMessageModel.side" />
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="주문가격" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-5 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Prices" Class="w-auto"
                            @bind-Value="createMessageModel.price" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="주문가격 대비 퍼센트(%)" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-5 rz-align-items-center d-flex">
                        <RadzenNumeric AllowClear="false" TValue="int" Class="w-auto"
                            @bind-Value="createMessageModel.price_pct" />
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="주문수량 방법 선택" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-2 rz-align-items-center d-flex">
                        <RadzenSelectBar TValue="bool" Class="w-auto"
                            @bind-Value=@useAmount>
                            <Items>
                                <RadzenSelectBarItem Text="주문수량 기준" Value="true" />
                                <RadzenSelectBarItem Text="기준자산 기준" Value="false" />
                            </Items>
                        </RadzenSelectBar>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="주문수량(개수)" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-2 rz-align-items-center d-flex">
                        <RadzenNumeric AllowClear="false" TValue="int?" Class="w-auto"
                            @bind-Value="createMessageModel.amount" Disabled="useAmount"/>
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="주문화폐" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-2 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Amount_Types" Class="w-auto"
                            @bind-Value="createMessageModel.amount_type" Disabled="useAmount" />
                    </RadzenColumn>

                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="기준자산" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-2 rz-align-items-center d-flex">
                        <RadzenDropDown AllowClear="false" TValue="string" Data="CreateMessageModelTypeList.Equity_Types" Class="w-auto"
                            @bind-Value="createMessageModel.equity" Disabled="!useAmount" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-1 rz-align-items-center d-flex">
                        <RadzenLabel Text="주문수량" class="rz-text-body1" />
                    </RadzenColumn>
                    <RadzenColumn class="rz-col-2 rz-align-items-center d-flex">
                        <RadzenNumeric AllowClear="false" TValue="int?" Class="w-auto"
                            @bind-Value="createMessageModel.bal_pct" Disabled="!useAmount"/>
                    </RadzenColumn>

                </RadzenRow>
            </RadzenCard>

        </RadzenColumn>
    </RadzenRow>
</RadzenContentContainer>



@code {
    CreateMessageModel createMessageModel;
    CreateMessageModelTypeList typeList = new();
    bool useAmount, useOpenOrder, useSameOrder, useTradingTime;

    protected override async Task OnInitializedAsync()
    {
        List<string> timeslots = GenerateTimeSlots();
        createMessageModel = new CreateMessageModel()
                             {
                                account = "기본계정",
                                type = "limit",
                                side = "buy",
                                price = "LAST"
                             };
        useAmount = false;
    }

    public List<string> GenerateTimeSlots()
    {
        var timeslots = new List<string>();
        for (int i = 0; i < 24; i++)
        {
            timeslots.Add($"{i:00}:00");
            timeslots.Add($"{i:00}:30");
        }
        return timeslots;
    }

    public static string SerializeToJson(CreateMessageModel data)
    {
        var options = new JsonSerializerOptions
        {
            WriteIndented = true, // 가독성을 위해 줄 바꿈과 들여쓰기 사용
            Converters = { new DecimalToStringConverter() } // 커스텀 변환기 사용
        };

        return JsonSerializer.Serialize(data, options);
}

    public class DecimalToStringConverter : System.Text.Json.Serialization.JsonConverter<decimal>
    {
        public override decimal Read(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)
        {
            var stringValue = reader.GetString();
            return decimal.Parse(stringValue);
        }

        public override void Write(Utf8JsonWriter writer, decimal value, JsonSerializerOptions options)
        {
            writer.WriteStringValue(Math.Round(value, 1).ToString());
        }
    }
}
